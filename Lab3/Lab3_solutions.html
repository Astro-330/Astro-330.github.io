
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab 3 Solutions &#8212; Astro 330 Course Book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lab 4: Solutions" href="../Lab4/Lab4_solutions.html" />
    <link rel="prev" title="Lab 2 Solutions" href="../Lab2/Lab2_solutions.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/a330_banner.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Astro 330 Course Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Astro 330 Course Book: Scientific Computing in Astrophysics
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Lecture1/Lecture1.html">
   1. Astronomical Imaging &amp; Functional Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lecture2/Lecture2.html">
   2. Object Oriented Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lecture4/Lecture4.html">
   4. Sampling with MCMC
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lecture6/Pandas.html">
   6. Pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lecture7/Lecture7.html">
   7. Building Installable Packages
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Labs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab1/Lab1.html">
   Lab 1: Overview, Review, and Environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab2/Lab2.html">
   Lab 2: Astronomical Imaging I
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Lab3.html">
   Lab 3: Building a Photometric Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab4/Lab4.html">
   Lab 4:  Fitting a Model to Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab5/Lab5.html">
   Lab 5: Stellar Spectroscopy + Fitting Models to Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab6/Lab6.html">
   Lab 6: Pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab7/Lab7.html">
   Lab 7: Package Structure
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Lab Solutions
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab1/Lab1_solutions.html">
   Lab 1 Solutions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab2/Lab2_solutions.html">
   Lab 2 Solutions
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lab 3 Solutions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab4/Lab4_solutions.html">
   Lab 4: Solutions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Lab5/Lab5_solutions.html">
   Lab 5 Solutions
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Final Projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../FinalProject/finalprojects.html">
   Final Project Guidelines
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Quick Tips
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../QuickTips/TimingCode.html">
   Timing your code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../QuickTips/Meshgrid.html">
   Meshgrid
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../QuickTips/MetropolisHastingsClass.html">
   An Object Oriented Metropolis Hastings
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Data Access
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data_access.html">
   Data Access
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Lab3/Lab3_solutions.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/Lab3/Lab3_solutions.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-1">
   Problem 1
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-1-1">
     Problem 1.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-1-2">
     Problem 1.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-1-3">
     Problem 1.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-1-4">
     Problem 1.4
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-2">
   Problem 2
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-2-1">
     Problem 2.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-2-2">
     Problem 2.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Problem 2.2
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-2-3">
   Problem 2.3
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-2-4">
     Problem 2.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-2-5">
     Problem 2.5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-2-6">
     Problem 2.6
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-3">
   Problem 3
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-3-1">
     Problem 3.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-3-2">
     Problem 3.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-3-3">
     Problem 3.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-3-4">
     Problem 3.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-4-3">
     Problem 4.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#problem-4-4">
     Problem 4.4
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#bonus-problem-1-extra-credit">
   Bonus Problem (+1 Extra Credit)
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="lab-3-solutions">
<h1>Lab 3 Solutions<a class="headerlink" href="#lab-3-solutions" title="Permalink to this headline">¶</a></h1>
<p>In this lab, we’ll be using classes and functions to build a pipeline which will automatically extract the fluxes of stars in an image. We’re all familiar with aperture photometry, but in this case, we’re going to take the additional step of convolving our image with a PSF.</p>
<p>Our pipeline will be split into several steps.</p>
<ol class="simple">
<li><p>Reading in an image</p></li>
<li><p>Finding the local peaks in the image (the stars)</p></li>
<li><p>Calculating the centroid of each peak region</p></li>
<li><p>Convolving with the PSF and extracting flux.</p></li>
</ol>
<div class="section" id="problem-1">
<h2>Problem 1<a class="headerlink" href="#problem-1" title="Permalink to this headline">¶</a></h2>
<p>In this problem, we’ll load in the image(s) for use and begin constructing our <code class="docutils literal notranslate"><span class="pre">PSFPhot</span></code> class.</p>
<div class="section" id="problem-1-1">
<h3>Problem 1.1<a class="headerlink" href="#problem-1-1" title="Permalink to this headline">¶</a></h3>
<p>Create a script (<code class="docutils literal notranslate"><span class="pre">.py</span></code> file) in this directory and copy into it your <code class="docutils literal notranslate"><span class="pre">load_fits()</span></code> and final <code class="docutils literal notranslate"><span class="pre">implot()</span></code> functions from last lab. Then import them here.</p>
<p>Use your <code class="docutils literal notranslate"><span class="pre">load_fits()</span></code> to read in in the image <code class="docutils literal notranslate"><span class="pre">2020-04-15-0001.fits</span></code> and plot it with <code class="docutils literal notranslate"><span class="pre">implot()</span></code>.</p>
<p>This image was taken of the M81/M82 field using the Dragonfly Telephoto Array (in a narrowband configuration).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="n">extension</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to load a FITS file into python</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fpath: str</span>
<span class="sd">        path to the FITS file to load. must end in .fit/.fits/.FIT/.FITS</span>
<span class="sd">    extension: int (optional)</span>
<span class="sd">        extension of the FITS file to load. (default 0)</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    header: dict_like</span>
<span class="sd">        the read in header of the chosen extension, as a python dictionary</span>
<span class="sd">    data: array_like</span>
<span class="sd">        the data contained in the extension, whether an image or table.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">implot</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">13</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray_r&#39;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot an astronomical image, setting default options and easy tweaking of parameters</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: array_like</span>
<span class="sd">        2D array containing an astronomical image to be plotted. Cutouts should be input as cutout.data.</span>
<span class="sd">    figsize: tuple, optional</span>
<span class="sd">        figure size to use. Default: (15,13)</span>
<span class="sd">    cmap: str, optional</span>
<span class="sd">        Colormap to use for the image. Default: &#39;gray_r&#39;</span>
<span class="sd">    scale: float, optional</span>
<span class="sd">        By default, function will scale image to some number of standard deviations about the mean pixel value. Scale sets this number (or fraction). Default: 0.5.</span>
<span class="sd">    colorbar: bool, optional</span>
<span class="sd">        Whether to add a colorbar or not. Default: False</span>
<span class="sd">    header: dict, optional</span>
<span class="sd">        If input, function will attempt to create a WCS object from header and plot in celestial coordinates. Default: None</span>
<span class="sd">    wcs: WCS object</span>
<span class="sd">        If input, the function will plot using a projection set by the WCS. Default: None</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional arguments are passed to matplotlib plotting commands. Currently supported: vmin, vmax.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax</span>
<span class="sd">        figure and axes objects containing currently plotted data.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">==</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">wcs</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span><span class="n">wcs</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [hms]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [degrees]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span><span class="n">wcs</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [hms]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [degrees]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">dvmin</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">scale</span><span class="o">*</span><span class="n">s</span>
    <span class="n">dvmax</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">scale</span><span class="o">*</span><span class="n">s</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">],</span><span class="n">vmax</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s1">&#39;vmin&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">],</span><span class="n">vmax</span><span class="o">=</span><span class="n">dvmax</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;vmax&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">dvmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">dvmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">dvmax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">header</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">)</span>
<span class="n">implot</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Lab3_solutions_3_0.png" src="../_images/Lab3_solutions_3_0.png" />
</div>
</div>
<p>M82 should be visible left of center, M81 on the left hand edge. Two features caused by detector amp glow are also visible at the bottom of the image.</p>
</div>
<div class="section" id="problem-1-2">
<h3>Problem 1.2<a class="headerlink" href="#problem-1-2" title="Permalink to this headline">¶</a></h3>
<p>Finish the syntax for creating the <code class="docutils literal notranslate"><span class="pre">PSFPhot</span></code> class below. The init for the class should ask for three string paths: one to an image, one to a dark file, and one to a flat file. Within <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>, use your <code class="docutils literal notranslate"><span class="pre">load_fits()</span></code> function to get the just the data image and header into the class. Store them as class attributes <code class="docutils literal notranslate"><span class="pre">self.data_init</span></code> and <code class="docutils literal notranslate"><span class="pre">self.data_header</span></code>.</p>
<p>Don’t forget to add a docstring to your init! It doesn’t return anything, but sets the initial attributes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="problem-1-3">
<h3>Problem 1.3<a class="headerlink" href="#problem-1-3" title="Permalink to this headline">¶</a></h3>
<p>Add a method to your class called <code class="docutils literal notranslate"><span class="pre">dark_subtract()</span></code> which takes an image and a string-path to a dark file. Use <code class="docutils literal notranslate"><span class="pre">load_fits()</span></code> to read it in the dark, and subtract it from the image, and return the output.</p>
<p>Add another method called <code class="docutils literal notranslate"><span class="pre">flat_field()</span></code> which takes in an image and a string-path to a flatfield file. Use <code class="docutils literal notranslate"><span class="pre">load_fits()</span></code> to read it in, normalize it to its maximum value, and divide the input image by it.</p>
<p>Finally, within your init function, set a new class attribute called <code class="docutils literal notranslate"><span class="pre">self.data_calibrated</span> <span class="pre">=</span> <span class="pre">flat_field(dark_subtract(self.data_init,dark_path),flat_path)</span></code>. (That is, run your calibrators. You need not nest the function, but these are simple enough to do so).</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">implot()</span></code> to plot both the <code class="docutils literal notranslate"><span class="pre">data_init</span></code> and <code class="docutils literal notranslate"><span class="pre">data_calibrated</span></code> and show that your calibrations worked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">dark_im</span><span class="p">,</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span> <span class="o">-</span> <span class="n">dark_im</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">flat_im</span><span class="p">,</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>
    
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="problem-1-4">
<h3>Problem 1.4<a class="headerlink" href="#problem-1-4" title="Permalink to this headline">¶</a></h3>
<p>The final step in setting up our image for proper analysis is the subtraction of the globally varying sky background. Performing that fit (generally a low order 2D polynomial of some kind) is beyond the scope of this lab, but we encourage you to look into this step more if you are interested.</p>
<p>Instead, we’re going to return to the <code class="docutils literal notranslate"><span class="pre">sep</span></code> package and take advantage of its background estimation feature. Recall it reads in the base image array and a separate mask. We want the user of this class to be able to supply a mask, so we won’t run this step automatically in <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.</p>
<p>Using the same stucture as in Lab 2, we’ll calculate the background using <code class="docutils literal notranslate"><span class="pre">sep</span></code>. This time though, add a method to your class that called <code class="docutils literal notranslate"><span class="pre">subtract_background(self,mask=None)</span></code>. Inside, use sep to again find, e.g., <code class="docutils literal notranslate"><span class="pre">bkg.back()</span></code>, and subtract it from <code class="docutils literal notranslate"><span class="pre">self.data_calibrated</span></code>. You should set <code class="docutils literal notranslate"><span class="pre">mask=mask</span></code> in the sep call. For convenient access, store the output of <code class="docutils literal notranslate"><span class="pre">bkg.back()</span></code> in a class attribute called <code class="docutils literal notranslate"><span class="pre">self.background</span></code>, and then set <code class="docutils literal notranslate"><span class="pre">self.image</span></code> equal to the background subtracted image. This method is known as a <em>setter</em>, because we’re setting a class attribute but not returning anything.</p>
<p>It can be handy here to add a print statement at the end of the method saying something like <code class="docutils literal notranslate"><span class="pre">&quot;Background</span> <span class="pre">estimated;</span> <span class="pre">output</span> <span class="pre">saved</span> <span class="pre">to</span> <span class="pre">attribute</span> <span class="pre">'image'</span> <span class="pre">&quot;</span></code>. Since this is the main image we’ll be using from now on, I’ve elected to give it the short name <code class="docutils literal notranslate"><span class="pre">image</span></code>. You may rather use something like <code class="docutils literal notranslate"><span class="pre">data_bg_sub</span></code>, for example</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Don’t forget about the C order switch.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">dark_im</span><span class="p">,</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span> <span class="o">-</span> <span class="n">dark_im</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">flat_im</span><span class="p">,</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>
    
    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute data_bg_sub&#39;</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<p>Now, when the class gets instantiated, users will run the subtract background method, but will have the option of supplying a manual mask if they choose.</p>
</div>
</div>
<div class="section" id="problem-2">
<h2>Problem 2<a class="headerlink" href="#problem-2" title="Permalink to this headline">¶</a></h2>
<p>Our goal is to estimate the PSF of the above image, then measure fluxes of the stars and galaxies here accounting for the PSF.</p>
<p>To start this process, we need to locate the stars in this image. We saw how to segment an image using <code class="docutils literal notranslate"><span class="pre">sep</span></code> last time, but in this lab we are going to carry out this step ourselves, using two methods.</p>
<div class="section" id="problem-2-1">
<h3>Problem 2.1<a class="headerlink" href="#problem-2-1" title="Permalink to this headline">¶</a></h3>
<p>Before we do this, we want to take the step of masking out several regions of the image which may register as peaks but which are not nicely isolated stars. In particular, the two galaxies need to be masked out when both estimating the background and when looking for point sources.</p>
<p>Create a mask of the dimensions of the image data, containing <code class="docutils literal notranslate"><span class="pre">False</span></code> everywhere except where we want to mask out the galaxies (rough rectangular regions are fine for this masking). It’s easiest to make the full array <code class="docutils literal notranslate"><span class="pre">False</span></code> first, then set the regions we want to mask to <code class="docutils literal notranslate"><span class="pre">True</span></code> via image indexing.</p>
<p>Add a method to your class called <code class="docutils literal notranslate"><span class="pre">set_image_mask(self,mask)</span></code> which overwrites <code class="docutils literal notranslate"><span class="pre">self.data</span></code> with a numpy masked array containing what used to be <code class="docutils literal notranslate"><span class="pre">self.image</span></code> as the data, with a mask that the user inputs. Test that this has worked; you should get an image like the one below.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If we have the memory to, it’s often worth avoiding overwriting class attributes. Here, we could set the masked image as <code class="docutils literal notranslate"><span class="pre">self.image_masked</span></code>, for example. I’ve elected not to here for two reasons. One: simplicity. Two: the unmasked version of the image is easily accessible still via <code class="docutils literal notranslate"><span class="pre">self.image.data</span></code>, the data attribute of numpy masked arrays.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">900</span><span class="p">:</span><span class="mi">1250</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">300</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mask</span><span class="p">[</span><span class="mi">850</span><span class="p">:</span><span class="mi">1200</span><span class="p">,</span><span class="mi">900</span><span class="p">:</span><span class="mi">1100</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">dark_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">dark_im</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">flat_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>

    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute image&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_image_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_14_1.png" src="../_images/Lab3_solutions_14_1.png" />
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In our instance here, the mask we will use when background subtracting is the same as the one we’ll use for blocking out regions from being included in peak finding and such. But our code is flexible enough to, e.g., mask when background-subtracting but not when peak finding, or vice versa. Our mask setter only affects the image data, and the mask argument in the subtract background method only affects background subtraction.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As it stands, <code class="docutils literal notranslate"><span class="pre">set_image_mask()</span></code> can only be run <em>after</em> <code class="docutils literal notranslate"><span class="pre">subtract_background()</span></code>, because that method sets <code class="docutils literal notranslate"><span class="pre">self.image</span></code> for the first time. We can use the <code class="docutils literal notranslate"><span class="pre">hasattr(self,'image')</span></code> check to see, when <code class="docutils literal notranslate"><span class="pre">set_image_mask()</span></code> is run, if that previous method was already run. For now, it’s ok to assume the user will use the class in order, but it can be helpful to either raise an exception or apply the mask to <code class="docutils literal notranslate"><span class="pre">data_calibrated</span></code> if the other method hasn’t been run.</p>
</div>
<p>Plot the <code class="docutils literal notranslate"><span class="pre">.background</span></code> attribute. It seems our image has a spatially varying background that includes a gradient across the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">background</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1080x936 with 2 Axes&gt;, &lt;AxesSubplot:&gt;)
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_17_1.png" src="../_images/Lab3_solutions_17_1.png" />
</div>
</div>
</div>
<div class="section" id="problem-2-2">
<h3>Problem 2.2<a class="headerlink" href="#problem-2-2" title="Permalink to this headline">¶</a></h3>
<p>Using what we have so far,</p>
<ul class="simple">
<li><p>instantiate an object using your class, which should handle the initial calibrations as well</p></li>
<li><p>run its <code class="docutils literal notranslate"><span class="pre">subtract_background()</span></code> method using the manual mask you created above</p></li>
<li><p>also run its <code class="docutils literal notranslate"><span class="pre">set_image_mask()</span></code> method using the same mask.</p></li>
</ul>
<p>We now, finally, are ready to begin using this masked, background subtracted, dark subtracted, flat fielded image to search for stars and do photometry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_19_1.png" src="../_images/Lab3_solutions_19_1.png" />
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Problem 2.2<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Now that we have the appropriate image regions masked, we can move on to the peak finder.</p>
<p>The “fast” or “efficient” method of doing this involves some scipy filtering operations. But for our purposes, the “slow way” (iterating over the image pixels) takes ~few seconds to run, and is worth doing to build intuition.</p>
<p>Add a method to your class to find peaks in an image by looping over each pixel and checking its neighbors, with a “peak” being defined as a region of higher flux than all adjacent pixels (i.e., the 8 surrounding pixels). In order to not pick up random noise pixels, also take an input called <code class="docutils literal notranslate"><span class="pre">threshold</span></code>. Within your algorithm, don’t return any pixels which are “peaks” but for which the pixel value is below this threshold.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>
<span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Algorithm for finding peaks (above a threshold) in an image</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: array_like</span>
<span class="sd">        2D array containing the image of interest.</span>
<span class="sd">    threshold: float</span>
<span class="sd">        minimum pixel value for inclusion in search</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    peak_x_values, peak_y_values: array_like, array_like</span>
<span class="sd">        arrays containing the x and y coordinates of peak regions.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">peak_x_values</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">peak_y_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edgewidth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edgewidth</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edgewidth</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edgewidth</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">edgewidth</span><span class="p">):</span>
            <span class="n">pixel</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pixel</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span><span class="p">(</span><span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
               <span class="n">pixel</span> <span class="o">&gt;</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">peak_x_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">peak_y_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_x_values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_y_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The looping solution is slow, and will not scale well if we have to run on many images, but for one image is okay.</p>
<p>There are several solutions which generally involve either <strong>filtering</strong> the image or <strong>cross correlating</strong> the image with a template. Here’s one such solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">maximum_filter</span>

<span class="k">def</span> <span class="nf">findpeaks_maxfilter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Algorithm for finding peaks (above a threshold) in an image</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image: array_like</span>
<span class="sd">        2D array containing the image of interest.</span>
<span class="sd">    threshold: float</span>
<span class="sd">        minimum pixel value for inclusion in search</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    peaks: array_like</span>
<span class="sd">        array containing the x and y coordinates of peak regions.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># just 3x3 True, defining the neighborhood over which to filter</span>
    <span class="c1"># find local maximum for each pixel</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="c1">#max filter will set each 9-square region in the image to the max in that region.</span>
    
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">image</span> <span class="o">==</span> <span class="n">amax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">))</span> <span class="c1">#find the pixels unaffected by the max filter.</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">peaks</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a moment to understand how this algorithm works. The key is in the <code class="docutils literal notranslate"><span class="pre">maximum_filter()</span></code> step. Filtering a 2D image is a process carried out in fourier space, which is what allows scipy to carry it out quickly. But what is maximum filtering?</p>
<div class="highlight-{admonition}Definition notranslate"><div class="highlight"><pre><span></span>Maximum Filtering is the process by which all pixels in local neighborhoods within an array are raised to the maximum value of any pixel in that neighborhood
</pre></div>
</div>
<p>Let’s look at a 1D case. Below, I define a 1D array that has some peaks in it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">array_1dpeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Our data looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7fc8ecf17ee0&gt;]
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_27_1.png" src="../_images/Lab3_solutions_27_1.png" />
</div>
</div>
<p>Let’s now run the maximum filter on this data and plot it’s output. I’m going to pick a neighborhood of 3, which means +/- 1 pixel around each location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mf</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;original array&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;max filtered array&#39;</span><span class="p">)</span>
<span class="n">eq</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array_1dpeaks</span><span class="o">==</span><span class="n">mf</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">))[</span><span class="n">eq</span><span class="p">],</span><span class="n">mf</span><span class="p">[</span><span class="n">eq</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;local peaks&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Lab3_solutions_30_0.png" src="../_images/Lab3_solutions_30_0.png" />
</div>
</div>
<p>What the filtering has done is for every 3 pixel neighborhood across this array, it’s raised the value of all three pixels to the maximum value across the three. So we see that anywhere the three pixels were, e.g., (1,2,1), they are all now 2. What you should notice looking at this plot is that the max filtering has also identified true peaks in our data! Notice that the only spots where the orange curve (the max filtered version of the data) is equal to the original array is exactly at locations that are local maxima. This is because when applying max filtering to an array, the only values <em>unchanged</em> by the filtering are those that <em>are</em> local maxima (in the neighborhood defined).</p>
<p>And thus, we have our peaks! All we need to do is find out <code class="docutils literal notranslate"><span class="pre">where()</span></code> the max filtered array equals the original array. Of course, we can also put in a threshold (in this example, maybe 2.5) to ensure low level noise doesn’t enter in. This is why the <code class="docutils literal notranslate"><span class="pre">findpeaks_maxfilter()</span></code> function has a threshold option as well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may notice that the first index in the array is marked as a peak, despite not being one. Edges are always troublesome with these algorithms, and they normally have multiple options for how edges are handled, e.g, interpolating a constant value, reflecting over the edge, etc. For our lab, we’re not going to worry about this.</p>
</div>
</div>
</div>
<div class="section" id="problem-2-3">
<h2>Problem 2.3<a class="headerlink" href="#problem-2-3" title="Permalink to this headline">¶</a></h2>
<p>For the rest of the lab, you can either leave in your peak finder, or replace it with the max-filtering version (turning the function above into a method). Either way, your method should be runnable with no inputs, with an optional threshold argument to set a minimum flux value for inclusion.</p>
<p>Before you decide, explicitly find out how slow the loop is compared to the max filtering.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">%%timeit</span></code> magic command in your notebook to test how fast the two algorithms are respectively. If you were working with a sample of 1000 images, how long would the looping algorithm take compared to the max-filtering case?</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Check out the “Timing Code” page in the “Quick Tips” sidebar tab of our website to see examples of using the <code class="docutils literal notranslate"><span class="pre">timeit</span></code> module.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">yp</span><span class="p">,</span><span class="n">xp</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8.01 s ± 465 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">pks</span> <span class="o">=</span> <span class="n">findpeaks_maxfilter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>142 ms ± 4.29 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mf">8.01</span> <span class="o">/</span> <span class="p">(</span><span class="mi">142</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>56.408450704225345
</pre></div>
</div>
</div>
</div>
<p>The max-filtering method is a factor of 56 faster than the loop! For 1000 images, it would take</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mf">8.06</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[2.2388889 \; \mathrm{h}\]</div>
</div>
</div>
<p>2.23 hours to run just the peak-finding part of the algorithm, compared to</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="mi">142</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[2.3666667 \; \mathrm{min}\]</div>
</div>
</div>
<p>2.3 minutes to run it using max filtering. Speed matters!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">dark_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">dark_im</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">flat_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>

    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute image&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_image_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">findpeaks_maxfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Algorithm for finding peaks (above a threshold) in an image</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            image: array_like</span>
<span class="sd">                2D array containing the image of interest.</span>
<span class="sd">            threshold: float</span>
<span class="sd">                minimum pixel value for inclusion in search</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            peaks: array_like</span>
<span class="sd">                array containing the x and y coordinates of peak regions.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># just 3x3 True, defining the neighborhood over which to filter</span>
            <span class="c1"># find local maximum for each pixel</span>
            <span class="n">amax</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="c1">#max filter will set each 9-square region in the image to the max in that region.</span>

            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">==</span> <span class="n">amax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">))</span> <span class="c1">#find the pixels unaffected by the max filter.</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">peaks</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="problem-2-4">
<h3>Problem 2.4<a class="headerlink" href="#problem-2-4" title="Permalink to this headline">¶</a></h3>
<p>Run your peakfinder on your masked image, and assemble the list of peaks you’ll use moving forward. Your peakfinder method should save a class attribute <code class="docutils literal notranslate"><span class="pre">self.peak_locations</span></code> which contains the (<span class="math notranslate nohighlight">\(x,y\)</span>) pairs of points associated with your peaks.</p>
<p>Plot up the original image, but use our “source circling” technique from last lab to circle all the peaks found in the masked image. I show mine below.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Recall that <code class="docutils literal notranslate"><span class="pre">implot()</span></code> returns a set of <code class="docutils literal notranslate"><span class="pre">fig,</span> <span class="pre">ax</span></code>, so you can then plot the circles onto the same axis as the image.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">findpeaks_maxfilter</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">))</span>
<span class="c1"># Note that this is returned in row, column form (so y,x).</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">pks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">mec</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_43_1.png" src="../_images/Lab3_solutions_43_1.png" />
</div>
</div>
</div>
<div class="section" id="problem-2-5">
<h3>Problem 2.5<a class="headerlink" href="#problem-2-5" title="Permalink to this headline">¶</a></h3>
<p>This should look pretty good – most of what’s circled above is clearly a star/point source in the image. However, one problem with this method is that single hot pixels are going to be registered as peaks, even via the clever algorithm. We need a way to eliminate these from our sample before moving on.</p>
<p>Adjust your peak-finder method to add in something that checks that not only is there a true peak, but that at least 4 of the pixels around the peak are also elevated in flux (I used 0.5 times the peak flux). The easiest way is to loop over the peaks after they’re found and institute the check — there are far fewer peaks than pixels, so this doesn’t significantly affect the runtime. But feel free to find a cleverer solution!</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be careful with transpositions in this problem. when you plot coordinates, you plot(x,y), but when you index the image, you index image[y,x]. Always be tracking which is which!</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">dark_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">dark_im</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">flat_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>

    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute image&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_image_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">findpeaks_maxfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Algorithm for finding peaks (above a threshold) in an image</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            image: array_like</span>
<span class="sd">                2D array containing the image of interest.</span>
<span class="sd">            threshold: float</span>
<span class="sd">                minimum pixel value for inclusion in search</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            peaks: array_like</span>
<span class="sd">                array containing the x and y coordinates of peak regions.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># just 3x3 True, defining the neighborhood over which to filter</span>
            <span class="c1"># find local maximum for each pixel</span>
            <span class="n">amax</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="c1">#max filter will set each 9-square region in the image to the max in that region.</span>

            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">==</span> <span class="n">amax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">))</span> <span class="c1">#find the pixels unaffected by the max filter.</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">out_peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">peak_flux</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">mini_cutout</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">accept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mini_cutout</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">peak_flux</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accept</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">out_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_peaks</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Re-find your peaks using your newer, better algorithm, and plot them below as before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">findpeaks_maxfilter</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">))</span>
<span class="c1"># Note that this is returned in row, column form (so y,x).</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">peaks</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">mec</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_47_1.png" src="../_images/Lab3_solutions_47_1.png" />
</div>
</div>
<p>Notice that we’ve decreased our total number of peaks. But you should find that now, everything currently circled looks like a bright, “resolved” star. (resolved insofar as the PSF is spreading the light of the star over multiple pixels).</p>
</div>
<div class="section" id="problem-2-6">
<h3>Problem 2.6<a class="headerlink" href="#problem-2-6" title="Permalink to this headline">¶</a></h3>
<p>In your the image above, you should see that ~8-10 stars look like they are circled by several very closely overlapping circles all targeting the same star. Infer (or investigate and determine) why this has happened, and write your answer below.</p>
<p>There are saturated stars in the image. When stars are saturated (at the peak value registered by the detector), they also don’t have true peaks – all values across the top of the star are the same max value (like a flat-top mesa). Our algorithm with max filtering thus registers all those pixels as peaks.</p>
</div>
</div>
<div class="section" id="problem-3">
<h2>Problem 3<a class="headerlink" href="#problem-3" title="Permalink to this headline">¶</a></h2>
<p>We now have a function that can return the peaks in a given image. Our next step is going to be to estimate the exact center of those peaks (stars) using their <strong>centroid</strong>.</p>
<div class="highlight-{admonition}Definition notranslate"><div class="highlight"><pre><span></span>The centroid is the light-weighted-mean of a set of pixels. It is not always the maximum-valued pixel, and is determined to sub-pixel accuracy.
</pre></div>
</div>
<p>Many of you have seen the centroid formula, but as a reminder, it looks like this (in 1D):</p>
<div class="math notranslate nohighlight">
\[
x_{\rm com} = \frac{\sum{x_i \hat{f}_i}}{\sum \hat{f}_i},
\]</div>
<p>where <span class="math notranslate nohighlight">\(x_i\)</span> are the positions and <span class="math notranslate nohighlight">\(\hat{f}_i\)</span> are the fluxes at those positions.</p>
<p>In 2D, when working with images, the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> centers of mass are independent, and the 2D centroid is just the location (<span class="math notranslate nohighlight">\(x_{\rm com}\)</span>, <span class="math notranslate nohighlight">\(y_{\rm com}\)</span>).</p>
<div class="section" id="problem-3-1">
<h3>Problem 3.1<a class="headerlink" href="#problem-3-1" title="Permalink to this headline">¶</a></h3>
<p>Add a method to your class called <code class="docutils literal notranslate"><span class="pre">centroid_cutout()</span></code> which should read in an image (which will be a cutout around each star) and the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> peak location returned by your peak finder, then create a window of NxN pixels around it (user-settable), and determine the centroid of this window. The <span class="math notranslate nohighlight">\(x,y\)</span> location of this centroid should be returned.</p>
<p>One subtlety — We want to use a window size greater than 1 pixel on either side of each peak. But because our peak finder is likely to have found peaks near the edge of the detector (both because it needs only 1 pixel-thick borders and because it handles edges), if we write a centroid function that, e.g., uses a 10x10 pixel window, we’ll end up trying to index over the edge of the original image whenever there’s a star near the edge. Because of this, your function should raise an exception if a peak position is entered whose distance from an edge is less than half the window size.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">dark_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">dark_im</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">flat_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>

    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute image&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_image_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">findpeaks_maxfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Algorithm for finding peaks (above a threshold) in an image</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            image: array_like</span>
<span class="sd">                2D array containing the image of interest.</span>
<span class="sd">            threshold: float</span>
<span class="sd">                minimum pixel value for inclusion in search</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            peaks: array_like</span>
<span class="sd">                array containing the x and y coordinates of peak regions.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># just 3x3 True, defining the neighborhood over which to filter</span>
            <span class="c1"># find local maximum for each pixel</span>
            <span class="n">amax</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="c1">#max filter will set each 9-square region in the image to the max in that region.</span>

            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">==</span> <span class="n">amax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">))</span> <span class="c1">#find the pixels unaffected by the max filter.</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">out_peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">peak_flux</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">mini_cutout</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">accept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mini_cutout</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">peak_flux</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accept</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">out_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_peaks</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">centroid_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">peak_x</span><span class="p">,</span><span class="n">peak_y</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given an image and list of peak positions, determine the centroid in the region of each peak.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image: array_like</span>
<span class="sd">            The image to centroid</span>
<span class="sd">        peak_x: int</span>
<span class="sd">            x position of a peak </span>
<span class="sd">        peak_y: int</span>
<span class="sd">            y position of a peak</span>
<span class="sd">        window: int, optional</span>
<span class="sd">            window within which to calculate the centroid, centered on the peak. Default: 10</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        centroids: array_like</span>
<span class="sd">            x,y ordered centroid associated with the input peak.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">boxwidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">peak_x</span><span class="o">-</span><span class="n">boxwidth</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">peak_x</span><span class="o">+</span><span class="n">boxwidth</span><span class="o">&gt;=</span><span class="n">ndim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">peak_y</span><span class="o">-</span><span class="n">boxwidth</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">peak_y</span><span class="o">+</span><span class="n">boxwidth</span><span class="o">&gt;=</span><span class="n">ndim</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Peak too close to edge. Try a smaller window or skip.&#39;</span><span class="p">)</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">peak_x</span><span class="o">-</span><span class="n">boxwidth</span><span class="p">,</span><span class="n">peak_x</span><span class="o">+</span><span class="n">boxwidth</span><span class="p">),</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">peak_y</span><span class="o">-</span><span class="n">boxwidth</span><span class="p">,</span><span class="n">peak_y</span><span class="o">+</span><span class="n">boxwidth</span><span class="p">))</span>
        <span class="n">image_cutout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">peak_y</span><span class="o">-</span><span class="n">boxwidth</span><span class="p">:</span><span class="n">peak_y</span><span class="o">+</span><span class="n">boxwidth</span><span class="p">,</span><span class="n">peak_x</span><span class="o">-</span><span class="n">boxwidth</span><span class="p">:</span><span class="n">peak_x</span><span class="o">+</span><span class="n">boxwidth</span><span class="p">]</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="o">*</span><span class="n">xx</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="p">)</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span>
        
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="problem-3-2">
<h3>Problem 3.2<a class="headerlink" href="#problem-3-2" title="Permalink to this headline">¶</a></h3>
<p>Use your <code class="docutils literal notranslate"><span class="pre">centroid_peak</span></code> function to confirm that the algorithm is working by testing it on a few individual peaks from your peak list, and make a plot showing the window region and the determined centroid (along with the location of the input peak). I’m leaving behind a demo of what I mean below. The blue point is the pixel with the peak flux, while the crosshairs center on the determined centroid</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s ok if the centroid is not at what appears to be the center of the light distribution of the star. Often due to seeing and detector effects, along with tricks of the stretch you happen to be using, the centroid doesn’t look perfectly centered.</p>
</div>
<p>In my solution below, I plot 25 stars from my peak finder, with peaks and centroids shown.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">findpeaks_maxfilter</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">10</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">10</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">testx</span><span class="p">,</span><span class="n">testy</span><span class="o">=</span><span class="n">pipe</span><span class="o">.</span><span class="n">centroid_peak</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">m</span><span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">testy</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">testx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;bo&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> <span class="p">;</span> <span class="n">ax</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;cutout.npy&#39;</span><span class="p">,</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
(326, 312)
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_53_1.png" src="../_images/Lab3_solutions_53_1.png" />
</div>
</div>
</div>
<div class="section" id="problem-3-3">
<h3>Problem 3.3<a class="headerlink" href="#problem-3-3" title="Permalink to this headline">¶</a></h3>
<p>Now do this for all peaks in your image. You may need to use <code class="docutils literal notranslate"><span class="pre">try</span></code> and <code class="docutils literal notranslate"><span class="pre">except</span></code> blocks to skip any peaks that raise errors in your centroid code for being too close to the edge. I’ll leave it to your discration whether you handle this by dropping that peak from the list and moving on, or by trying a smaller window first. (The second requires a bit more boiler plate but would allow you to retain a larger selection of stars).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_cen</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">centroid_peak</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">all_cen</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">continue</span>
<span class="n">all_cen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cen</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="problem-3-4">
<h3>Problem 3.4<a class="headerlink" href="#problem-3-4" title="Permalink to this headline">¶</a></h3>
<p>If you recall from above, you determined why the peak algorithm occasionally marked a bunch of pixels as peaks within the same star, which shouldn’t happen. It should be clear from your answer that these stars will be unusable for the purposes of measuring the PSF of stars in the image. We thus need to remove these ~8-10 stars from our sample.</p>
<p>Write a function which takes in the list of centroids, and identifies these cases. The easiest way to do this is to simply iterate through the list of centroids and compute the distance to all other centroids in the list. Any centroid which has another centroid very nearby (within, say, 5 pixels) should be removed from our sample.</p>
<p>This function should return the final list of centroids for use. Plot them over the data to confirm these “stacked” peak cases have been removed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fig, ax = implot(pipe.image,scale=0.5)</span>
<span class="n">out_cen</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_cen</span><span class="p">)):</span>
    <span class="n">sub2</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_cen</span> <span class="o">-</span> <span class="n">all_cen</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sqt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>
    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sqt</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">out_cen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_cen</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">out_cen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_cen</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">implot</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">out_cen</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">out_cen</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">mec</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7fc84b30c880&gt;]
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_59_1.png" src="../_images/Lab3_solutions_59_1.png" />
</div>
</div>
<p>I’m going to integrate the above two bits into my final method.</p>
</div>
<div class="section" id="problem-4-3">
<h3>Problem 4.3<a class="headerlink" href="#problem-4-3" title="Permalink to this headline">¶</a></h3>
<p>Armed with a dark-subtracted, flat-fielded, background-subtracted image, as well as with a list of centroids corresponding to stars in our image, we are ready to estimate the PSF.</p>
<p>There are two main functional forms typically used to fit star profiles: 2D Gaussians, and Moffat profiles (which combines the shapes of a Gaussian and Lorentzian to best match both the inner and outer regions of the PSF).</p>
<p>We’re going to use the <a class="reference external" href="https://docs.astropy.org/en/stable/api/astropy.modeling.functional_models.Gaussian2D.html"><code class="docutils literal notranslate"><span class="pre">Gaussian2D</span></code></a> class from <code class="docutils literal notranslate"><span class="pre">astropy</span></code> to do this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.modeling.functional_models</span> <span class="kn">import</span> <span class="n">Gaussian2D</span>
</pre></div>
</div>
</div>
</div>
<p>For each star, a Gaussian2D profile (normalized) will be used “as the PSF”. The parameters we need to know for this profile are <span class="math notranslate nohighlight">\(x,y\)</span>, for which we’ll use the centroids we calculated earlier, the amplitude (set by the normalization), and <span class="math notranslate nohighlight">\(\sigma_x,\sigma_y\)</span>, the standard deviations in the two axes. For this lab, we’re going to assume our stars are circular (<span class="math notranslate nohighlight">\(\sigma_x=\sigma_y\)</span>). This is a strictly incorrect, but not a bad assumption for most cases. All other optional arguments we won’t need, primarily due to the assumption of circularity.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are going to make a point estimate of the “size” of the stars in our image, which constrains us from using a more fancy model for the PSF. An example of a more sophisticated setup would be <em>fitting</em> a Gaussian or Moffat profile to every star, and in a Bayesian framework marginalizing over the stars to determine the best-fit PSF (including ellipticity, etc) for the image, or, even fancier, interpolating a PSF model which varies over the detector.</p>
</div>
<p>PSF photometry works by multiplying the <em>data</em> (say, a cutout around a star) by the <em>estimated PSF</em> during the fluxing stage. Instead of picking a radius and performing aperture photometry (which includes fully all pixels within the aperture and throws out all pixels beyond), this method attempts to weight each pixel fractionally by how likely it is to be stellar flux, with the weighting coming from the PSF of the detector. This means further pixels may still be included, but will contribute less than pixels near the center of the star.</p>
<p>The formula for measuring the PSF flux of a star is</p>
<div class="math notranslate nohighlight">
\[
f_{\rm PSF} = \frac{\sum \hat{f_i} p_i}{\sum p_i^2},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{f_i}\)</span> are the fluxes in your image and <span class="math notranslate nohighlight">\(p_i\)</span> is your PSF estimate. This formula should be reminiscent of the centroiding formula; it’s a similar weighting scheme.</p>
<p><code class="docutils literal notranslate"><span class="pre">Gaussian2D</span></code> is a class, but we want to interact with it pretty simply, and have simplified inputs. I’ve made a quick wrapper function below which allows us to enter a single <span class="math notranslate nohighlight">\(\sigma\)</span> and then <span class="math notranslate nohighlight">\(x,y\)</span> grids created via <code class="docutils literal notranslate"><span class="pre">np.meshgrid()</span></code>, and creates the Gaussian and evaluates it on our grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_gauss</span><span class="p">(</span><span class="n">x_arr</span><span class="p">,</span><span class="n">y_arr</span><span class="p">,</span><span class="n">sigma_x</span><span class="p">,</span><span class="n">sigma_y</span><span class="p">,</span><span class="n">mu_x</span><span class="p">,</span><span class="n">mu_y</span><span class="p">):</span>
    
    <span class="n">g</span> <span class="o">=</span> <span class="n">Gaussian2D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_arr</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y_arr</span><span class="p">,</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">x_mean</span><span class="o">=</span><span class="n">mu_x</span><span class="p">,</span>
                   <span class="n">y_mean</span><span class="o">=</span><span class="n">mu_y</span><span class="p">,</span>
                   <span class="n">x_stddev</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span>
                   <span class="n">y_stddev</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">)</span>
    <span class="n">g</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">))</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">eval_gauss</span><span class="p">(</span><span class="n">x_arr</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span><span class="n">y_arr</span><span class="o">=</span><span class="n">yy</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">mu_x</span><span class="o">=</span><span class="n">testx</span><span class="p">,</span><span class="n">mu_y</span><span class="o">=</span><span class="n">testy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7fc8bc202580&gt;
</pre></div>
</div>
<img alt="../_images/Lab3_solutions_67_1.png" src="../_images/Lab3_solutions_67_1.png" />
</div>
</div>
<p>As we can see, I now have a model for the PSF which I can easily create for given inputs. We’re going to do this for cutouts around each star, and instead of a random <span class="math notranslate nohighlight">\(\sigma\)</span>, we’re going to estimated it using the second moment (moment of inertia) of the star itself.</p>
<p>The formula for this (from Markevich et al. 1989) is</p>
<div class="math notranslate nohighlight">
\[
\sigma_x = \left[\frac{\sum x_i^2 \hat{f}_i}{\sum \hat{f}_i} - x_{\rm com}^2\right]^{1/2}
\]</div>
<div class="math notranslate nohighlight">
\[
\sigma_y = \left[\frac{\sum y_i^2 \hat{f}_i}{\sum \hat{f}_i} - y_{\rm com}^2\right]^{1/2}
\]</div>
<p>In this case, we’ll need to use <code class="docutils literal notranslate"><span class="pre">meshgrid()</span></code> directly within our second moment function, as you can see it depends on the difference between the pixels and the centroid.</p>
<p>Add a method to your class called <code class="docutils literal notranslate"><span class="pre">second_moment</span></code> which reads in an image cutout, the meshgrid input (xx,yy) (or constructs it), and finally, a centroid (x and y). Inside, use the formulas above to determine sigma_x and sigma_y, and return them</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">second_moment</span><span class="p">(</span><span class="n">image_cutout</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">centroid_x</span><span class="p">,</span><span class="n">centroid_y</span><span class="p">):</span>
    <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">image_cutout</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="p">)</span>
    <span class="n">T2x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">image_cutout</span><span class="p">)</span>
    <span class="n">T2y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">image_cutout</span><span class="p">)</span>
    <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T2x</span><span class="o">/</span><span class="n">T</span> <span class="o">-</span> <span class="n">centroid_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T2y</span><span class="o">/</span><span class="n">T</span> <span class="o">-</span> <span class="n">centroid_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">second_moment</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">testx</span><span class="p">,</span><span class="n">testy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2.9221417526244626, 2.9860561887708132)
</pre></div>
</div>
</div>
</div>
<p>Within 10%, this calculation, which requires no fitting, tells us <span class="math notranslate nohighlight">\(\sigma\)</span> (under the assumption the distribution is Gaussian). Thus, by running out image cutouts through this function, we can derive for ourselves a good <span class="math notranslate nohighlight">\(\sigma\)</span> to choose in our Gaussian model of the PSF.</p>
</div>
<div class="section" id="problem-4-4">
<h3>Problem 4.4<a class="headerlink" href="#problem-4-4" title="Permalink to this headline">¶</a></h3>
<p>We now have everything we need to run our pipeline.</p>
<p>Right now, our final three methods (peak finder, centroider, and width-finder) all <em>return</em> their values. I had you do it that way for testing purposes. To finalize our “object oriented pipeline” though, we should adapt these.</p>
<p>Modify your peak-finder method to save the peaks to a class attribute.</p>
<p>We’ll leave the centroid and second moment functions alone, since they act on individual stars. Instead, we’ll write a new, final method called <code class="docutils literal notranslate"><span class="pre">psf_photometry</span></code>. When the user runs this method, it should first feed the peaks into the centroid code one by one, assembling a set of centroids. It should then construct cutouts of <code class="docutils literal notranslate"><span class="pre">self.image</span></code> around each peak (or centroid), and feed those, plus the centroids, into the second moment function to save a pair sigma_x and sigma_y for each star as well. And finally, it should use the eval_gauss function I’ve provided above to carry out the PSF photometry.</p>
<p>At the end of it all, you can save the centroids, widths, and psf-fluxes all to class attributes, where they will remain accessible. You can also find a nice way to return them (see below).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="k">class</span> <span class="nc">PSFPhot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_fpath</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">,</span><span class="n">flat_fpath</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_init</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_init</span><span class="p">,</span><span class="n">dark_fpath</span><span class="p">),</span><span class="n">flat_fpath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">dark_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">dark_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">dark_im</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">flat_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">image</span><span class="p">,</span><span class="n">flat_path</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span><span class="n">flat_im</span> <span class="o">=</span> <span class="n">load_fits</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
        <span class="n">flat_im</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flat_im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">/</span><span class="n">flat_im</span>

    <span class="k">def</span> <span class="nf">subtract_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data_corder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">Background</span><span class="p">(</span><span class="n">data_corder</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">bkg</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background estimated; output saved to attribute image&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_image_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mask</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_calibrated</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">findpeaks_maxfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Algorithm for finding peaks (above a threshold) in an image</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            image: array_like</span>
<span class="sd">                2D array containing the image of interest.</span>
<span class="sd">            threshold: float</span>
<span class="sd">                minimum pixel value for inclusion in search</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            peaks: array_like</span>
<span class="sd">                array containing the x and y coordinates of peak regions.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># just 3x3 True, defining the neighborhood over which to filter</span>
            <span class="c1"># find local maximum for each pixel</span>
            <span class="n">amax</span> <span class="o">=</span> <span class="n">maximum_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span> <span class="c1">#max filter will set each 9-square region in the image to the max in that region.</span>

            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">==</span> <span class="n">amax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">))</span> <span class="c1">#find the pixels unaffected by the max filter.</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">out_peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">peak_flux</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">mini_cutout</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">accept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mini_cutout</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">peak_flux</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accept</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">out_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_peaks</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calc_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">image_cutout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">y</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">window</span><span class="p">,</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">window</span><span class="p">]</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">window</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">window</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">window</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">window</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="p">)</span>
        <span class="n">cutout_flux</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">centroid_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="o">*</span><span class="n">xx</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
        <span class="n">centroid_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
        <span class="n">T2x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">image_cutout</span><span class="p">)</span>
        <span class="n">T2y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">image_cutout</span><span class="p">)</span>
        <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T2x</span><span class="o">/</span><span class="n">T</span> <span class="o">-</span> <span class="n">centroid_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T2y</span><span class="o">/</span><span class="n">T</span> <span class="o">-</span> <span class="n">centroid_y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">eval_gauss</span><span class="p">(</span><span class="n">x_arr</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span><span class="n">y_arr</span><span class="o">=</span><span class="n">yy</span><span class="p">,</span><span class="n">sigma_x</span><span class="o">=</span><span class="n">sigma_x</span><span class="p">,</span><span class="n">sigma_y</span><span class="o">=</span><span class="n">sigma_y</span><span class="p">,</span><span class="n">mu_x</span><span class="o">=</span><span class="n">centroid_x</span><span class="p">,</span><span class="n">mu_y</span><span class="o">=</span><span class="n">centroid_y</span><span class="p">)</span>
        <span class="n">psf_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image_cutout</span><span class="o">*</span><span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">centroid_x</span><span class="p">,</span><span class="n">centroid_y</span><span class="p">,</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">cutout_flux</span><span class="p">,</span><span class="n">psf_flux</span>

    <span class="k">def</span> <span class="nf">aperture_photometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeaks_maxfilter</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found Peaks&#39;</span><span class="p">)</span>
        
        <span class="n">star_properties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">window</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">window</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="p">):</span>
                    <span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">sigx</span><span class="p">,</span><span class="n">sigy</span><span class="p">,</span><span class="n">cutout_flux</span><span class="p">,</span><span class="n">psf_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_moments</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
                    <span class="n">star_properties</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">sigx</span><span class="p">,</span><span class="n">sigy</span><span class="p">,</span><span class="n">cutout_flux</span><span class="p">,</span><span class="n">psf_flux</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Centroided and Second Moment Measured the Peaks&#39;</span><span class="p">)</span>
        <span class="n">star_properties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">star_properties</span><span class="p">)</span>  
        <span class="n">out_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">star_properties</span><span class="p">)):</span>
            <span class="n">sub2</span> <span class="o">=</span> <span class="p">(</span><span class="n">star_properties</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_cen</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sqt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sqt</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">out_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">star_properties</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">out_props</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_props</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Removed Saturated Stars&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;centroid_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;centroid_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">2</span><span class="p">];</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sigma_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cutout_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">4</span><span class="p">];</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;psf_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_props</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_table</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">df</span>
        
        
        
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">PSFPhot</span><span class="p">(</span><span class="s1">&#39;2020-04-15-0001.fits&#39;</span><span class="p">,</span>
               <span class="n">dark_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-dark.fits&#39;</span><span class="p">,</span>
               <span class="n">flat_fpath</span><span class="o">=</span><span class="s1">&#39;2020-04-15-flat.fits&#39;</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">subtract_background</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">set_image_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> 
<span class="n">df</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">aperture_photometry</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Background estimated; output saved to attribute image
Found Peaks
Centroided and Second Moment Measured the Peaks
Removed Saturated Stars
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-783-d6b08dd593c6&gt;:71: RuntimeWarning: invalid value encountered in sqrt
  sigma_x = np.sqrt(T2x/T - centroid_x**2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>centroid_x</th>
      <th>centroid_y</th>
      <th>sigma_x</th>
      <th>sigma_y</th>
      <th>cutout_flux</th>
      <th>psf_flux</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>362.655705</td>
      <td>10.326548</td>
      <td>1.886595</td>
      <td>1.976730</td>
      <td>184779.849982</td>
      <td>196567.032561</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2193.767467</td>
      <td>46.944986</td>
      <td>1.800662</td>
      <td>1.950200</td>
      <td>64483.041675</td>
      <td>69128.800476</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1412.435090</td>
      <td>57.018075</td>
      <td>1.823663</td>
      <td>2.019020</td>
      <td>83374.606011</td>
      <td>90812.510783</td>
    </tr>
    <tr>
      <th>3</th>
      <td>705.665737</td>
      <td>160.209360</td>
      <td>1.931244</td>
      <td>2.033910</td>
      <td>320015.727883</td>
      <td>340472.820597</td>
    </tr>
    <tr>
      <th>4</th>
      <td>355.806723</td>
      <td>172.542875</td>
      <td>1.962915</td>
      <td>2.065964</td>
      <td>578935.400071</td>
      <td>611639.609731</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>105</th>
      <td>1932.118494</td>
      <td>2103.867512</td>
      <td>2.301403</td>
      <td>2.320404</td>
      <td>198417.480753</td>
      <td>196641.333693</td>
    </tr>
    <tr>
      <th>106</th>
      <td>1596.192032</td>
      <td>2112.402385</td>
      <td>2.307307</td>
      <td>2.296160</td>
      <td>174719.526438</td>
      <td>174677.408344</td>
    </tr>
    <tr>
      <th>107</th>
      <td>2411.836096</td>
      <td>2162.730994</td>
      <td>2.102614</td>
      <td>2.329944</td>
      <td>291193.386076</td>
      <td>289959.501256</td>
    </tr>
    <tr>
      <th>108</th>
      <td>105.318450</td>
      <td>2166.163610</td>
      <td>2.520967</td>
      <td>2.551289</td>
      <td>464461.888789</td>
      <td>441463.111353</td>
    </tr>
    <tr>
      <th>109</th>
      <td>2549.764488</td>
      <td>2180.724678</td>
      <td>2.118850</td>
      <td>2.254683</td>
      <td>89694.423134</td>
      <td>89104.358988</td>
    </tr>
  </tbody>
</table>
<p>110 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">6e4</span><span class="p">,</span><span class="mf">1e7</span><span class="p">],[</span><span class="mf">6e4</span><span class="p">,</span><span class="mf">1e7</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1:1 relation&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cutout_flux</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">psf_flux</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Cutout Flux (square aperture)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PSF Flux (gaussian model)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">});</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Lab3_solutions_76_0.png" src="../_images/Lab3_solutions_76_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="bonus-problem-1-extra-credit">
<h2>Bonus Problem (+1 Extra Credit)<a class="headerlink" href="#bonus-problem-1-extra-credit" title="Permalink to this headline">¶</a></h2>
<p>A convenient way to return the set of measurements carried out by our pipeline is via a <code class="docutils literal notranslate"><span class="pre">flux</span> <span class="pre">table</span></code>, like the one returned by <code class="docutils literal notranslate"><span class="pre">aperture_photometry</span></code> from <code class="docutils literal notranslate"><span class="pre">astropy</span></code>. For our purposes, since we’ll be spending a lot of time with data frames, let’s go with that.</p>
<p>Modify your final <code class="docutils literal notranslate"><span class="pre">psf_photometry</span></code> method to assemble a nice <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> which contains as colummns <code class="docutils literal notranslate"><span class="pre">peak_x</span></code>, <code class="docutils literal notranslate"><span class="pre">peak_y</span></code>, <code class="docutils literal notranslate"><span class="pre">centroid_x</span></code>, <code class="docutils literal notranslate"><span class="pre">centroid_y</span></code>, <code class="docutils literal notranslate"><span class="pre">width_x</span></code>, <code class="docutils literal notranslate"><span class="pre">width_y</span></code>, and <code class="docutils literal notranslate"><span class="pre">psf_flux</span></code>. Each row should be the relevant values for a given star that was originally found by your peakfinder (but which made it through our sample cleaning stage).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Inside your final method, you probably have lists or arrays containing the output of your centroid and width methods as they looped over the stars (and your find peak function returns a list of positions outright). So if you set up an empty DataFrame, you can set, e.g., <code class="docutils literal notranslate"><span class="pre">df['peak_x']</span> <span class="pre">=</span> <span class="pre">peaks[:,0]</span></code> or something like <code class="docutils literal notranslate"><span class="pre">df['width_x']</span> <span class="pre">=</span> <span class="pre">out_widths</span></code>, to set up these columns. As long as you never messed with the order of the lists, it should turn into the desired output frame.</p>
</div>
<p>(see above)</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "a330"
        },
        kernelOptions: {
            kernelName: "a330",
            path: "./Lab3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'a330'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../Lab2/Lab2_solutions.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Lab 2 Solutions</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../Lab4/Lab4_solutions.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Lab 4: Solutions</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Imad Pasha & Marla Geha<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
    
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>


    
  </body>
</html>